<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>RTOS vs. Super Loop | Building DC Energy Systems</title>
    <meta name="generator" content="VuePress 1.8.1">
    <link rel="apple-touch-icon" sizes="180x180" href="/favicons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicons/favicon-16x16.png">
    <link rel="manifest" href="/favicons/site.webmanifest">
    <link rel="mask-icon" href="/favicons/safari-pinned-tab.svg" color="#5bbad5">
    <link rel="shortcut icon" href="/favicons/favicon.ico">
    <meta name="description" content="Open Educational Resource (OER) by Libre Solar to explain how to develop, produce and use components for DC energy systems">
    <meta name="msapplication-TileColor" content="#2b5797">
    <meta name="msapplication-config" content="/favicons/browserconfig.xml">
    <meta name="theme-color" content="#ffffff">
    
    <link rel="preload" href="/assets/css/0.styles.8526d307.css" as="style"><link rel="preload" href="/assets/js/app.eb1db606.js" as="script"><link rel="preload" href="/assets/js/3.afa2b13a.js" as="script"><link rel="preload" href="/assets/js/9.b737edab.js" as="script"><link rel="preload" href="/assets/js/28.6786b827.js" as="script"><link rel="preload" href="/assets/js/14.6a044d5c.js" as="script"><link rel="prefetch" href="/assets/js/1.5ce743f2.js"><link rel="prefetch" href="/assets/js/10.516dbec6.js"><link rel="prefetch" href="/assets/js/11.a0354c70.js"><link rel="prefetch" href="/assets/js/12.efcc4453.js"><link rel="prefetch" href="/assets/js/13.70250085.js"><link rel="prefetch" href="/assets/js/15.e699ddaa.js"><link rel="prefetch" href="/assets/js/16.f7a083a1.js"><link rel="prefetch" href="/assets/js/17.fd67d296.js"><link rel="prefetch" href="/assets/js/18.4badd3a5.js"><link rel="prefetch" href="/assets/js/19.b0da9baf.js"><link rel="prefetch" href="/assets/js/20.391b60cd.js"><link rel="prefetch" href="/assets/js/21.f59891cf.js"><link rel="prefetch" href="/assets/js/22.154d22c1.js"><link rel="prefetch" href="/assets/js/23.9e3b570d.js"><link rel="prefetch" href="/assets/js/24.f1c73a25.js"><link rel="prefetch" href="/assets/js/25.06efb72a.js"><link rel="prefetch" href="/assets/js/26.f6d096f5.js"><link rel="prefetch" href="/assets/js/27.4795d7cc.js"><link rel="prefetch" href="/assets/js/29.ea4f0826.js"><link rel="prefetch" href="/assets/js/30.ae308fed.js"><link rel="prefetch" href="/assets/js/31.0fb19ab4.js"><link rel="prefetch" href="/assets/js/32.0d0dfe9f.js"><link rel="prefetch" href="/assets/js/33.e163f558.js"><link rel="prefetch" href="/assets/js/34.69890252.js"><link rel="prefetch" href="/assets/js/35.eedfce07.js"><link rel="prefetch" href="/assets/js/36.13c5e925.js"><link rel="prefetch" href="/assets/js/37.01fef042.js"><link rel="prefetch" href="/assets/js/38.a8431c3f.js"><link rel="prefetch" href="/assets/js/39.7b9c3687.js"><link rel="prefetch" href="/assets/js/4.45530275.js"><link rel="prefetch" href="/assets/js/40.62db5135.js"><link rel="prefetch" href="/assets/js/41.4f5c956d.js"><link rel="prefetch" href="/assets/js/42.79b35d36.js"><link rel="prefetch" href="/assets/js/43.8512aa92.js"><link rel="prefetch" href="/assets/js/44.3f3c0545.js"><link rel="prefetch" href="/assets/js/45.a87c299c.js"><link rel="prefetch" href="/assets/js/46.1002321c.js"><link rel="prefetch" href="/assets/js/47.faac797e.js"><link rel="prefetch" href="/assets/js/48.a137f4ae.js"><link rel="prefetch" href="/assets/js/5.f3ba3bcc.js"><link rel="prefetch" href="/assets/js/6.4be0dc07.js"><link rel="prefetch" href="/assets/js/7.6fd8a947.js"><link rel="prefetch" href="/assets/js/8.ffe8369e.js">
    <link rel="stylesheet" href="/assets/css/0.styles.8526d307.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Building DC Energy Systems</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/system/" class="nav-link">
  System Layout
</a></div><div class="nav-item"><a href="/development/" class="nav-link router-link-active">
  Component Development
</a></div><div class="nav-item"><a href="/production/" class="nav-link">
  Production
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/system/" class="nav-link">
  System Layout
</a></div><div class="nav-item"><a href="/development/" class="nav-link router-link-active">
  Component Development
</a></div><div class="nav-item"><a href="/production/" class="nav-link">
  Production
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Hardware</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/development/dcdc_converter.html" class="sidebar-link">DC/DC Converter</a></li><li><a href="/development/load_switch.html" class="sidebar-link">Load Switch</a></li><li><a href="/development/current_measurement.html" class="sidebar-link">Current measurement</a></li><li><a href="/development/heat_dissipation.html" class="sidebar-link">Heat dissipation</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Firmware</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/development/firmware_frameworks.html" class="sidebar-link">Frameworks</a></li><li><a href="/development/rtos_super_loop.html" aria-current="page" class="active sidebar-link">RTOS vs. Super Loop</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/development/rtos_super_loop.html#super-loop-architecture" class="sidebar-link">Super Loop architecture</a></li><li class="sidebar-sub-header"><a href="/development/rtos_super_loop.html#multiple-threads" class="sidebar-link">Multiple threads</a></li><li class="sidebar-sub-header"><a href="/development/rtos_super_loop.html#advantages-and-disadvantages" class="sidebar-link">Advantages and disadvantages</a></li></ul></li><li><a href="/development/flashing_debugging.html" class="sidebar-link">Flashing and debugging</a></li><li><a href="/development/digital_control.html" class="sidebar-link">Digital control</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Communication</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/development/communication.html" class="sidebar-link">Communication</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="rtos-vs-super-loop"><a href="#rtos-vs-super-loop" class="header-anchor">#</a> RTOS vs. Super Loop</h1> <p>A real-time operating system (RTOS) provides functions like multithreading, inter-process communication and memory handling to embedded applications.</p> <p>As the name suggests, such an operating system includes a scheduler to ensure deterministic timing of critical tasks. However, this is often not the key reason for choosing an RTOS over a bare-metal approach to firmware development. The ability to run different tasks in parallel allows to write applications in a completely different way. If the firmware can be split into multiple tasks, it can be structured in a more modular way, which is especially helpful for complex projects with higher-level communication interfaces.</p> <p>In contrast to an RTOS approach, firmware can also be developed using a super loop architecture. This is the more traditional and sometimes more easy to understand way of embedded firmware development.</p> <p>The following sections will explain the differences between both approaches and give an overview of pros and cons to help with the decision for or against an RTOS.</p> <h2 id="super-loop-architecture"><a href="#super-loop-architecture" class="header-anchor">#</a> Super Loop architecture</h2> <p>The super loop architecture uses one central infinite loop, which coordinates the actions in the firmware. Often it handles the following sequence of tasks:</p> <ol><li>Read inputs</li> <li>Process information (e.g. state machine)</li> <li>Output results</li> <li>Delay until next loop execution</li></ol> <p>If tasks run with different time intervals, the super loop has to take care which function should be called in which run of the loop.</p> <p>A super loop design can also work in an event-driven way through interrupts. The interrupt service routines (ISRs) provide a simple way of multi-tasking because they interrupt the execution of the main loop. However, ISRs always have to be very short and don't allow to wait e.g. for slow communication interfaces, as this would block the execution of the main loop.</p> <h3 id="code-example"><a href="#code-example" class="header-anchor">#</a> Code example</h3> <p>For further explanations of the concepts, a simple temperature warning application programmed in Arduino syntax is used. It implements the following tasks:</p> <ul><li>Get a temperature measurement once per second</li> <li>If the temperature is above 30Â°C, a warning LED should start blinking with 500 ms on-time</li> <li>Once the temperature is below 30Â°C again, the LED should stop blinking</li></ul> <div class="language-C extra-class"><pre class="language-c"><code><span class="token comment">// variables to store states</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> ledState <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> bool tempAlarm <span class="token operator">=</span> false<span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> loopCounter <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">setup</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">// ... (some initializations)</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">loop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">// temperature measurements (every second)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>loopCounter <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getTemperature</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">30.0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            tempAlarm <span class="token operator">=</span> true<span class="token punctuation">;</span>
            ledState <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>       <span class="token comment">// start blinking with on state</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token punctuation">{</span>
            tempAlarm <span class="token operator">=</span> false<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// LED handling (every call, 500 ms interval)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>tempAlarm<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">digitalWrite</span><span class="token punctuation">(</span>ledPin<span class="token punctuation">,</span> ledState<span class="token punctuation">)</span><span class="token punctuation">;</span>
        ledState <span class="token operator">=</span> <span class="token operator">!</span>ledState<span class="token punctuation">;</span>   <span class="token comment">// change state for next call</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">digitalWrite</span><span class="token punctuation">(</span>ledPin<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    loopCounter<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">// minimum interval of all tasks</span>
<span class="token punctuation">}</span>
</code></pre></div><p>As we can see, the the super loop handles two different tasks. First it reads the temperature measurements and afterwards it blinks the LEDs depending on the results of the temperature processing.</p> <p>The timing of the different tasks is shown in Fig. 1. For simplicity reasons, the program uses a constant 500 ms delay between each loop, which would introduce a small drift in the intervals because the processing for the calculations is added to the interval. In reality, these simple calculations take a negligible amount of time, so they are ignored here and the figure shows the time durations in an exaggerated way.</p> <figure><center><img src="/images/development/tasks-super-loop.svg" alt="Tasks in a super loop architecture" height="auto" width="auto"> <figcaption><b>Figure 1.</b> Tasks in a super loop architecture.</figcaption></center></figure> <p>As the blinking task needs to be run more often, we need some variables to store the current state of the system. In a more complex system, a state machine could be used for this task instead of using just a simple boolean variable.</p> <h2 id="multiple-threads"><a href="#multiple-threads" class="header-anchor">#</a> Multiple threads</h2> <p>Now we look at the same example as above, but built using an RTOS.</p> <p>Instead of storing the different states for each new execution of the super loop, we separate each task into a dedicated thread. In this way, one thread can just wait for a signal from another thread and the different states don't need to be stored anymore.</p> <p>The following code example uses the Zephyr RTOS API for demonstration.</p> <div class="language-C extra-class"><pre class="language-c"><code><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">k_poll_signal</span> temp_alarm<span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">// ... (some initializations)</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span>true<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// handle temperature measurements in main thread</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">get_temperature</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">30.0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// trigger alarm to start blinking in LED thread</span>
            <span class="token function">k_poll_signal_raise</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>temp_alarm<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token function">k_poll_signal_reset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>temp_alarm<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">k_sleep</span><span class="token punctuation">(</span><span class="token function">K_SEC</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">led_thread</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">// ... (initialization: assign temp_alarm to an events array)</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span>true<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// wait here if no event (i.e. temp_alarm) is active</span>
        <span class="token function">k_poll</span><span class="token punctuation">(</span>events<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> K_FOREVER<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// blink LED</span>
        <span class="token function">gpio_pin_set</span><span class="token punctuation">(</span>led_dev<span class="token punctuation">,</span> led_pin<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">k_sleep</span><span class="token punctuation">(</span><span class="token function">K_MSEC</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">gpio_pin_set</span><span class="token punctuation">(</span>led_dev<span class="token punctuation">,</span> led_pin<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">k_sleep</span><span class="token punctuation">(</span><span class="token function">K_MSEC</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// create LED thread with priority 1 and start it immediately</span>
<span class="token function">K_THREAD_DEFINE</span><span class="token punctuation">(</span>led_tid<span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">,</span> led_thread<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Now there are two infinite loops, one in each thread. Both threads communicate via the signal <code>temp_alarm</code>. If the signal is not active, the LED thread intentionally gets stuck in the <code>k_poll</code> call. Only when the signal was raised from the main thread, the <code>k_poll</code> call returns immediately and the LEDs start blinking.</p> <p>The timing diagram in Fig. 2 shows the two independent threads. However, because the MCU cannot actually handle two things in parallel, the scheduler prioritizes the main thread over the blinking thread. Thus, the final outcome of the multithreaded design is exactly the same as in the super loop in this case.</p> <figure><center><img src="/images/development/tasks-multithreading.svg" alt="Tasks in a multithreaded architecture" height="auto" width="auto"> <figcaption><b>Figure 2.</b> Tasks in a multithreaded architecture.</figcaption></center></figure> <h2 id="advantages-and-disadvantages"><a href="#advantages-and-disadvantages" class="header-anchor">#</a> Advantages and disadvantages</h2> <p>There is no general rule when an RTOS should be used and when not. Even very complex projects can be accomplished with a super loop architecture and carefully chosen interrupts. And also super loops can be real-time capable.</p> <p>That being said, an RTOS can make life easier in the following situations:</p> <ul><li>If there are multiple slow tasks that need to run in parallel (like different communication interfaces) a state machine to keep track of each task can get very complicated. Dedicated tasks with a scheduler make the implementation more straight-forward.</li> <li>Higher-level communication like IP networking and Bluetooth will almost certainly require an RTOS environment.</li> <li>You might also be interested in the package that comes with an RTOS, e.g. the drivers.</li></ul> <p>Under the following circumstances, a super loop can be the better solution:</p> <ul><li>If the firmware needs to run on very constrained hardware, the overhead of an RTOS can be too much. Especially the amount of RAM can be critical, as each RTOS thread requires its own stack space, which increases overall memory consumption.</li> <li>For short high-priority tasks that need to interrupt a slow main loop, a simple multitasking using ISRs can be sufficient and easier to maintain.</li></ul></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/LibreSolar/learn.libre.solar/edit/master/docs/development/rtos_super_loop.md" target="_blank" rel="noopener noreferrer">Edit this page on GitHub!</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">11/16/2020, 9:41:14 AM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      â
      <a href="/development/firmware_frameworks.html" class="prev">
        Frameworks
      </a></span> <span class="next"><a href="/development/flashing_debugging.html">
        Flashing and debugging
      </a>
      â
    </span></p></div>  <div class="footer">
    Content provided by <a href="https://libre.solar">Libre Solar</a> under <a href="https://creativecommons.org/licenses/by-sa/4.0/legalcode">CC-BY-SA 4.0 License</a> | <a href="https://libre.solar/about/contact/">Contact / Impressum</a></div></main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.eb1db606.js" defer></script><script src="/assets/js/3.afa2b13a.js" defer></script><script src="/assets/js/9.b737edab.js" defer></script><script src="/assets/js/28.6786b827.js" defer></script><script src="/assets/js/14.6a044d5c.js" defer></script>
  </body>
</html>
